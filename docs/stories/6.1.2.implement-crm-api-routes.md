
---
story_id: 6.1.2
epic_id: 6.1
title: "Implement CRM API Routes"
status: "Draft"
priority: "P0 (Critical - Unblocks UI)"
estimate: "3 story points"
dev_agent: "TBD"
---

# Story 6.1.2: Implement CRM API Routes

**As a** Frontend Developer,
**I want** a stable and documented set of API endpoints for the CRM service,
**so that** I can build the user interface for managing customers.

## Acceptance Criteria

- [ ] A new `crmRoutes.ts` file is created in the `server/routes/` directory.
- [ ] All CRM endpoints as defined in the `API Endpoints` section of story `6.1.1.core-crm-foundation-story.md` are implemented.
- [ ] Each route correctly imports and calls the corresponding method from the existing `crmService.ts`.
- [ ] All API routes are protected by the `requireAuth` middleware.
- [ ] Basic unit tests are created for the new routes to ensure they handle requests, call the service, and return responses correctly.

## Tasks / Subtasks

- [x] **Task 1: Create CRM Routes File** (AC: 1)
    - [x] Create the file `server/routes/crmRoutes.ts`.
    - [x] Set up the Express router and import the `CRMService` instance.
    - [x] Add the new `crmRouter` to the main Express app in `server/index.ts` under the `/api` path.

- [x] **Task 2: Implement Customer CRUD Endpoints** (AC: 2, 3, 4)
    - [x] Implement `GET /customers` to list customers.
    - [x] Implement `POST /customers` to create a new customer.
    - [x] Implement `GET /customers/:id` to get customer details.
    - [x] Implement `PUT /customers/:id` to update a customer.
    - [x] Implement `DELETE /customers/:id` to delete a customer.
    - [x] Ensure all routes use the `requireAuth` middleware.

- [x] **Task 3: Implement Customer Intelligence Endpoints** (AC: 2, 3, 4)
    - [x] Implement `GET /customers/:id/health`.
    - [x] Implement `POST /customers/:id/health/update`.
    - [x] Implement `GET /customers/:id/timeline`.
    - [x] Implement `POST /customers/:id/activities`.

- [x] **Task 4: Implement Search, Segmentation, and Team Endpoints** (AC: 2, 3, 4)
    - [x] Implement `POST /customers/search`.
    - [x] Implement `GET /customers/segments/:id`.
    - [x] Implement `POST /customers/export`.
    - [x] Implement `PUT /customers/:id/assign`.
    - [x] Implement `GET /api/users/:repId/customers`.

- [x] **Task 5: Create Unit Tests** (AC: 5)
    - [x] Create `server/routes/crmRoutes.test.ts`.
    - [x] Write basic tests for each endpoint to verify route registration, request handling, and service method invocation. Mock the `crmService` to isolate the routes for testing.

## Dev Agent Record
### Agent Model Used
- Primary: Gemini

### Debug Log References
- (none)

### Completion Notes List
- All CRM API endpoints implemented and unit tests created.
- Router integrated into `server/index.ts`.
- All endpoints protected by `requireAuth` middleware.

### File List
- `server/routes/crmRoutes.ts`
- `server/routes/crmRoutes.test.ts`
- `server/index.ts` (modified)

### Change Log
| Date       | Version | Description                 | Author       |
|------------|---------|-----------------------------|--------------|
| 2025-09-21 | 1.0     | Initial draft of API story. | Bob (Scrum Master) |
| 2025-09-21 | 1.1     | Implemented all API endpoints and unit tests. | James (Developer) |

---
status: "Ready for Review"
