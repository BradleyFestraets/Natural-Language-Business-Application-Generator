
---
story_id: 6.1.1
epic_id: 6.1
title: "Core CRM Foundation & Customer Database"
status: "Draft"
priority: "P0 (Critical - CRM Foundation)"
estimate: "8 story points"
dev_agent: "TBD"
---

# Story 6.1.1: Core CRM Foundation & Customer Database

**As a** Business User  
**I want** comprehensive customer relationship management with 360-degree customer view  
**So that** I can manage all customer interactions across applications, sales, marketing, and support in one unified system

## Story Overview

This story establishes the foundational CRM system that transforms the platform from application-only to comprehensive business operations. The CRM serves as the central customer intelligence hub, tracking every interaction across generated applications, sales processes, marketing campaigns, and support tickets.

## Acceptance Criteria

### AC1: Customer Database with Comprehensive Profile Management
- [ ] Customer records with personal info (name, email, phone, company, title, address)
- [ ] Customer status management (lead, prospect, customer, churned) with automated transitions
- [ ] Customer health scoring based on application usage, support interactions, and engagement patterns
- [ ] Customer custom fields framework for industry-specific data collection
- [ ] Multi-tenant customer isolation with organization-scoped data access

### AC2: Customer 360-Degree View Integration
- [ ] Unified customer profile aggregating application usage, sales activities, marketing interactions, support tickets
- [ ] Customer interaction timeline with cross-system activity tracking and correlation
- [ ] AI-powered customer insights and relationship optimization recommendations
- [ ] Real-time customer data synchronization across all business systems

### AC3: Customer Search, Filtering & Segmentation
- [ ] Advanced customer search with filters, criteria, and saved searches
- [ ] Dynamic customer segmentation engine with rule-based and AI-powered classification
- [ ] Customer list management with export capabilities and bulk operations
- [ ] Customer assignment to sales reps and team management with workload balancing

### AC4: CRM Service Architecture & API Framework
- [ ] CustomerManagementService with comprehensive CRUD operations and business logic
- [ ] Customer health scoring algorithm with risk assessment and intervention triggers
- [ ] API framework for CRM data access across all business systems
- [ ] Real-time customer data synchronization with applications, marketing, and support

## Tasks & Subtasks

### Task 1: Implement Customer Data Model & Database Schema
**Estimate**: 2 story points  
**Priority**: P0 (Critical)

- [ ] Create Customer table in shared/schema.ts with comprehensive fields
  - [ ] Add customer personal information fields (name, email, phone, company, title, address)
  - [ ] Implement customer status enum (lead, prospect, customer, churned)
  - [ ] Add customer health scoring fields and metadata
  - [ ] Create custom fields framework for extensible customer data
- [ ] Add customer lifecycle management with status transitions
- [ ] Implement organization-scoped customer data access for multi-tenancy
- [ ] Create customer relationships with other business system entities

### Task 2: Build Customer Management Service
**Estimate**: 2 story points  
**Priority**: P0 (Critical)

- [ ] Create CustomerManagementService with comprehensive CRUD operations
  - [ ] Implement customer creation, reading, updating, deletion with validation
  - [ ] Add customer search and filtering capabilities with performance optimization
  - [ ] Build customer assignment and team management functionality
  - [ ] Create customer bulk operations and export capabilities
- [ ] Implement customer health scoring algorithm
  - [ ] Develop health scoring based on application usage patterns
  - [ ] Add support interaction history analysis for health calculation
  - [ ] Create risk assessment and intervention trigger logic
  - [ ] Build customer engagement tracking and scoring updates

### Task 3: Create Customer 360-Degree View & Integration
**Estimate**: 2 story points  
**Priority**: P0 (Critical)

- [ ] Build unified customer profile aggregating all system interactions
  - [ ] Integrate application usage data for customer activity tracking
  - [ ] Connect sales opportunity data with customer profiles
  - [ ] Link marketing campaign interactions and engagement metrics
  - [ ] Correlate support ticket history and resolution outcomes
- [ ] Create customer timeline with cross-system activity tracking
  - [ ] Implement chronological activity feed with activity types and context
  - [ ] Add activity correlation logic for relationship insights
  - [ ] Build activity filtering and search within customer timeline
  - [ ] Create activity export and reporting capabilities

### Task 4: Implement Customer Search, Segmentation & Analytics
**Estimate**: 2 story points  
**Priority**: P1 (High)

- [ ] Build advanced customer search and filtering system
  - [ ] Implement full-text search across customer data with indexing
  - [ ] Add filter combinations for complex customer queries
  - [ ] Create saved search functionality for recurring customer lists
  - [ ] Build customer list export with format options
- [ ] Create customer segmentation engine
  - [ ] Implement rule-based segmentation with dynamic updates
  - [ ] Add AI-powered customer behavior analysis and classification
  - [ ] Build segment performance tracking and optimization
  - [ ] Create customer journey mapping and stage tracking

## Technical Implementation Requirements

### Database Schema Updates

```typescript
// Enhanced Customer table in shared/schema.ts
export const customers = pgTable("customers", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  organizationId: varchar("organization_id").notNull().references(() => organizations.id),
  
  // Personal Information
  firstName: varchar("first_name"),
  lastName: varchar("last_name"),
  email: varchar("email").notNull(),
  phone: varchar("phone"),
  company: varchar("company"),
  title: varchar("title"),
  address: json("address").$type<{
    street?: string;
    city?: string;
    state?: string;
    zipCode?: string;
    country?: string;
  }>(),
  
  // Customer Status & Lifecycle
  customerStatus: varchar("customer_status", { 
    enum: ["lead", "prospect", "customer", "churned"] 
  }).notNull().default("lead"),
  customerType: varchar("customer_type", { 
    enum: ["individual", "business", "enterprise"] 
  }).notNull().default("individual"),
  
  // Customer Intelligence
  customerValue: real("customer_value").default(0),
  customerHealth: json("customer_health").$type<{
    score: number;
    riskFactors: string[];
    lastCalculated: string;
    trends: { date: string; score: number }[];
  }>(),
  
  // Lead Attribution
  acquisitionSource: varchar("acquisition_source"),
  acquisitionCampaign: varchar("acquisition_campaign"),
  firstTouchpoint: varchar("first_touchpoint"),
  
  // Sales Assignment
  assignedSalesRep: varchar("assigned_sales_rep").references(() => users.id),
  salesTerritory: varchar("sales_territory"),
  
  // Custom Fields Framework
  customFields: json("custom_fields").$type<Record<string, any>>(),
  
  // Metadata
  tags: json("tags").$type<string[]>(),
  notes: text("notes"),
  isActive: boolean("is_active").notNull().default(true),
  
  // Timestamps
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
  lastInteractionAt: timestamp("last_interaction_at")
});

// Customer Activity Timeline
export const customerActivities = pgTable("customer_activities", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  customerId: varchar("customer_id").notNull().references(() => customers.id),
  organizationId: varchar("organization_id").notNull().references(() => organizations.id),
  
  activityType: varchar("activity_type", {
    enum: ["application_usage", "sales_interaction", "marketing_engagement", "support_ticket", "manual_note"]
  }).notNull(),
  
  activitySubtype: varchar("activity_subtype"), // specific action within type
  description: text("description").notNull(),
  
  // Activity Context
  relatedEntityType: varchar("related_entity_type"), // application, opportunity, campaign, ticket
  relatedEntityId: varchar("related_entity_id"),
  
  // Activity Metadata
  metadata: json("metadata").$type<Record<string, any>>(),
  actorId: varchar("actor_id").references(() => users.id), // who performed the activity
  
  createdAt: timestamp("created_at").defaultNow().notNull()
});
```

### Service Architecture

```typescript
// server/services/customerManagementService.ts
export interface CustomerSearchFilters {
  status?: string[];
  healthScore?: { min?: number; max?: number };
  assignedRep?: string[];
  territory?: string[];
  tags?: string[];
  customFields?: Record<string, any>;
  dateRange?: { start: Date; end: Date };
}

export interface CustomerHealthMetrics {
  applicationUsage: number;
  supportInteractions: number;
  marketingEngagement: number;
  paymentHistory: number;
  overallScore: number;
  riskFactors: string[];
  recommendations: string[];
}

export class CustomerManagementService {
  // Core CRUD Operations
  async createCustomer(customerData: CreateCustomerData, organizationId: string): Promise<Customer>
  async getCustomer(customerId: string, organizationId: string): Promise<Customer | null>
  async updateCustomer(customerId: string, updates: Partial<Customer>, organizationId: string): Promise<Customer>
  async deleteCustomer(customerId: string, organizationId: string): Promise<boolean>
  
  // Search & Filtering
  async searchCustomers(filters: CustomerSearchFilters, organizationId: string): Promise<Customer[]>
  async getCustomersBySegment(segmentId: string, organizationId: string): Promise<Customer[]>
  
  // Customer Health & Intelligence
  async calculateCustomerHealth(customerId: string): Promise<CustomerHealthMetrics>
  async updateCustomerHealth(customerId: string): Promise<void>
  async getCustomersAtRisk(organizationId: string): Promise<Customer[]>
  
  // Customer Timeline & Activities
  async getCustomerTimeline(customerId: string): Promise<CustomerActivity[]>
  async addCustomerActivity(activity: CreateCustomerActivity): Promise<CustomerActivity>
  
  // Team Management
  async assignCustomerToRep(customerId: string, repId: string): Promise<void>
  async getRepCustomers(repId: string): Promise<Customer[]>
}
```

## API Endpoints

### Customer Management Endpoints

```typescript
// Customer CRUD
GET    /api/customers                    // List customers with filtering
POST   /api/customers                    // Create new customer
GET    /api/customers/:id                // Get customer details
PUT    /api/customers/:id                // Update customer
DELETE /api/customers/:id                // Delete customer

// Customer Intelligence
GET    /api/customers/:id/health         // Get customer health metrics
POST   /api/customers/:id/health/update  // Recalculate health score
GET    /api/customers/:id/timeline       // Get customer activity timeline
POST   /api/customers/:id/activities     // Add customer activity

// Customer Search & Segmentation
POST   /api/customers/search             // Advanced customer search
GET    /api/customers/segments/:id       // Get customers in segment
POST   /api/customers/export             // Export customer data

// Team Management
PUT    /api/customers/:id/assign         // Assign customer to sales rep
GET    /api/users/:repId/customers       // Get rep's customers
```

## Dev Agent Record

### Agent Model Used
- Primary: GPT-4o for complex business logic and AI-powered features
- Secondary: Claude-3 for data modeling and API design

### Completion Notes
- [ ] Customer data model implemented with comprehensive schema
- [ ] Customer health scoring algorithm developed and tested
- [ ] Customer 360-degree view with cross-system integration
- [ ] Advanced search and segmentation capabilities built
- [ ] API endpoints created and documented
- [ ] Multi-tenant security implemented and verified
- [ ] Performance optimization for large customer datasets

### File List
Files created or modified during implementation:
- [ ] shared/schema.ts (Customer and CustomerActivity tables)
- [ ] server/services/customerManagementService.ts (Core CRM service)
- [ ] server/routes/crmRoutes.ts (Customer API endpoints)
- [ ] client/src/pages/customer-dashboard.tsx (Customer management UI)
- [ ] client/src/components/crm/CustomerProfile.tsx (Customer 360 view)
- [ ] client/src/components/crm/CustomerSearch.tsx (Search and filtering)
- [ ] tests/unit/customer-management.test.ts (Unit tests)
- [ ] tests/integration/crm-integration.test.ts (Integration tests)

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-19 | 1.0 | Initial CRM foundation story for business platform | Scrum Master |

## Definition of Done
- [ ] All acceptance criteria implemented and tested
- [ ] Customer data model created with proper relationships
- [ ] Customer health scoring algorithm functional
- [ ] Customer 360-degree view showing cross-system data
- [ ] Search and segmentation features working
- [ ] API endpoints documented and tested
- [ ] Multi-tenant security verified
- [ ] Performance tested with 10,000+ customer records
- [ ] Integration tests passing for cross-system functionality
- [ ] Code reviewed and approved
- [ ] Ready for QA testing and user acceptance
