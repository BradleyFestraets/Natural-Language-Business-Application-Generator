# Story 1.2: Replit Auth Integration

## Status
Draft

## Story
**As a** Business User,  
**I want** to securely authenticate using Replit Auth integration,  
**so that** I can access personalized platform features with enterprise-grade security and role-based access.

## Acceptance Criteria
1. Replit Auth OAuth integration using existing platform capabilities (no custom OAuth providers)
2. User profile creation/retrieval using IStorage interface in server/storage.ts
3. Authentication middleware with token verification and RBAC permission checking
4. Frontend auth state management using React Query v5 with proper queryKeys
5. All auth-related UI elements have data-testid attributes for testing
6. Secure session management with httpOnly cookies (no localStorage token storage)
7. Role-based routing protection for business_user and technical_user roles
8. API endpoints return proper HTTP status codes (401, 403, 200) for auth scenarios

## Tasks / Subtasks
- [ ] Setup Replit Auth integration (AC: 1)
  - [ ] Use existing Replit Log In integration from project integrations
  - [ ] Create /api/auth/login route redirecting to Replit Auth
  - [ ] Implement /api/auth/callback route for OAuth callback handling
  - [ ] Add /api/auth/logout route clearing secure sessions
- [ ] Implement authentication middleware (AC: 3)
  - [ ] Create auth middleware in server/middleware/auth.ts
  - [ ] Implement requireAuth middleware checking valid sessions
  - [ ] Add RBAC checking with business_user/technical_user roles
  - [ ] Apply middleware to protected routes in server/routes.ts
- [ ] User profile management (AC: 2)
  - [ ] Implement IStorage interface in server/storage.ts with MemStorage
  - [ ] Add createUser(user: InsertUser): Promise<SelectUser> method
  - [ ] Add getUserById(id: string): Promise<SelectUser | null> method
  - [ ] Create /api/auth/me route using getUserById with proper error handling
- [ ] Frontend auth integration (AC: 4, 5)
  - [ ] Create useAuth hook using React Query v5 object form
  - [ ] Setup queryKey: ['auth', 'user'] with proper cache invalidation
  - [ ] Add login/logout components with data-testid="button-login", data-testid="button-logout"
  - [ ] Create ProtectedRoute component for role-based access
- [ ] Secure session management (AC: 6)
  - [ ] Use httpOnly cookies for session storage (never localStorage)
  - [ ] Implement secure cookie settings (sameSite, secure flags)
  - [ ] Add session expiration and refresh logic
- [ ] Role-based routing (AC: 7, 8)
  - [ ] Implement role checking in ProtectedRoute component
  - [ ] Add proper HTTP status responses (401 unauthorized, 403 forbidden)
  - [ ] Create role-specific redirects based on user.role

## Dev Notes
**Architecture Alignment:**
- Use existing Replit Log In integration - DO NOT implement custom OAuth providers
- Follow IStorage interface pattern in server/storage.ts (not separate storage folder)
- Use MemStorage for MVP with User table from shared/schema.ts
- Secure sessions with httpOnly cookies, never localStorage for tokens

**Key File Locations:**
- `server/storage.ts` - IStorage interface with MemStorage implementation
- `server/middleware/auth.ts` - Authentication and RBAC middleware
- `server/routes.ts` - Auth routes (/api/auth/login, /api/auth/callback, /api/auth/me)
- `client/src/hooks/useAuth.ts` - React Query auth hook with object form
- `client/src/components/auth/ProtectedRoute.tsx` - Role-based route protection

**RBAC Implementation:**
- Roles: 'business_user' | 'technical_user' (from shared/schema.ts User type)
- Permissions: Template access, project creation, deployment rights
- Middleware checks user.role against required permissions per route

**React Query Integration:**
- queryKey: ['auth', 'user'] for current user data
- queryKey: ['auth', 'status'] for authentication status
- Cache invalidation on login/logout using queryClient.invalidateQueries(['auth'])

### Testing
**Framework:** Vitest for unit tests, MSW for API mocking
**Test Locations:**
- `server/middleware/auth.test.ts` - Auth middleware and RBAC testing
- `server/storage.test.ts` - IStorage implementation and user operations
- `client/src/hooks/useAuth.test.ts` - Auth hook behavior and state management

**Required Tests:**
- Authentication middleware properly validates sessions (401 for invalid)
- RBAC middleware enforces role permissions (403 for insufficient)
- User CRUD operations via IStorage interface work correctly
- useAuth hook manages authentication state and cache properly
- Protected routes redirect based on authentication and role status

**Security Tests:**
- Tokens stored in httpOnly cookies (not accessible via JavaScript)
- Session expiration handled correctly with appropriate redirects
- RBAC prevents unauthorized access to role-restricted resources

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-18 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review of completed story implementation*