
---
story_id: 6.1.4
epic_id: 6.1
title: "Implement CRM Database Schema Migration"
status: "Draft"
priority: "P0 (Critical - Blocker for API)"
estimate: "2 story points"
dev_agent: "TBD"
---

# Story 6.1.4: Implement CRM Database Schema Migration

**As a** Developer,
**I want** to create and apply a database migration for the new CRM tables,
**so that** the database schema is synchronized with the application's data models, allowing the API to function correctly.

## Story Overview

This is a technical story to update the database schema. It involves using the project's ORM, Drizzle, to generate a migration file that reflects the new `customers` and `customerActivities` tables defined in `shared/schema.ts`. This story is a hard prerequisite for the API story (6.1.2), as the API endpoints will fail without the corresponding database tables.

## Acceptance Criteria

- [ ] A new SQL migration file is generated in the `drizzle` directory using the `drizzle-kit` CLI.
- [ ] The generated migration file correctly contains the `CREATE TABLE` statements for the `customers` and `customerActivities` tables.
- [ ] The migration is successfully applied to the development database without errors.
- [ ] The schema in the live development database is inspected and confirmed to match the table definitions in `shared/schema.ts`.

## Tasks / Subtasks

- [ ] **Task 1: Verify Schema Definitions** (AC: 2)
    - [ ] Open `shared/schema.ts`.
    - [ ] Compare the `customers` and `customerActivities` table definitions with the `Technical Implementation Requirements` in story `6.1.1.core-crm-foundation-story.md` to ensure they are complete and accurate.

- [ ] **Task 2: Generate Migration File** (AC: 1)
    - [ ] Find the migration generation script in `package.json` (e.g., `npm run db:generate`).
    - [ ] Run the script to generate a new migration file.
    - [ ] Review the generated SQL file to ensure it accurately creates the tables as defined.

- [ ] **Task 3: Apply Migration** (AC: 3)
    - [ ] Find the script or command to run database migrations.
    - [ ] Execute the command to apply the new migration to the development database.

- [ ] **Task 4: Verify Database Schema** (AC: 4)
    - [ ] Connect to the PostgreSQL development database.
    - [ ] Use a tool or query (`\d customers`) to inspect the schema of the new tables.
    - [ ] Confirm that all columns, types, and constraints match the Drizzle schema definition.

## Dev Notes

This is a purely technical story with no UI component. It is critical to unblock all other CRM-related development.

-   **ORM**: Drizzle ORM [Source: `docs/architecture.md`]
-   **Database**: PostgreSQL [Source: `docs/architecture.md`]
-   **Schema Definition Source**: `shared/schema.ts`. The required schemas for `customers` and `customerActivities` are already detailed in story `6.1.1`.
-   **Tooling**: You must use the `drizzle-kit` package to generate the migration. The project should already have this configured. Look for relevant scripts in `package.json`.

### Testing
-   Testing for this story is purely through verification. There are no automated tests to write. The Definition of Done is confirming the migration runs successfully and the database schema is updated correctly.

## Change Log

| Date       | Version | Description                        | Author       |
|------------|---------|------------------------------------|--------------|
| 2025-09-21 | 1.0     | Initial draft of DB migration story. | Bob (Scrum Master) |
