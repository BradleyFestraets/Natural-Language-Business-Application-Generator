
---
story_id: 10.2.5
epic_id: 10.2
title: "Implement Business Intelligence API Routes"
status: "Draft"
priority: "P1 (High - Unblocks Analytics UI)"
estimate: "4 story points"
dev_agent: "TBD"
---

# Story 10.2.5: Implement Business Intelligence API Routes

**As a** Business Analyst,
**I want** a stable and documented set of API endpoints for the Business Intelligence service,
**so that** I can create dashboards, process natural language queries, and view unified analytics from the UI.

## Story Overview

This story creates the API layer for the `businessIntelligenceService.ts`. This service is the brain of the platform, providing unified analytics, AI-powered insights, and natural language query capabilities. These endpoints will allow the frontend to visualize complex business data from across all integrated systems (CRM, Sales, Marketing, Support).

## Acceptance Criteria

- [ ] A new `biRoutes.ts` file is created in the `server/routes/` directory.
- [ ] Endpoints for retrieving analytics, processing natural language queries, and managing dashboards are implemented.
- [ ] All routes correctly call the corresponding methods in `businessIntelligenceService.ts`.
- [ ] All API routes are protected by the `requireAuth` middleware.
- [ ] The new router is integrated into the main Express app in `server/index.ts`.
- [ ] Unit tests are created for the new routes, mocking the service layer.

## Tasks / Subtasks

- [ ] **Task 1: Create and Integrate BI Routes File** (AC: 1, 5)
    - [ ] Create the file `server/routes/biRoutes.ts`.
    - [ ] Set up the Express router and import the `BusinessIntelligenceService` instance.
    - [ ] Add the new `biRouter` to the main Express app in `server/index.ts` under the `/api/bi` path.

- [ ] **Task 2: Implement Analytics and Query Endpoints** (AC: 2, 3)
    - [ ] Implement `GET /analytics` to call `getUnifiedAnalytics`.
    - [ ] Implement `POST /query` to call `processNaturalLanguageQuery`.

- [ ] **Task 3: Implement Dashboard Management Endpoints** (AC: 2, 3)
    - [ ] Implement `POST /dashboards` to call `createDashboard`.
    - [ ] Implement `GET /dashboards/:id` to call `getDashboard`.

- [ ] **Task 4: Create Unit Tests** (AC: 6)
    - [ ] Create `server/routes/biRoutes.test.ts`.
    - [ ] Write basic tests for each new endpoint, mocking the `businessIntelligenceService` dependency.

## Dev Notes

This story is the final piece needed to enable the creation of a powerful, unified analytics dashboard.

-   **Framework**: Use Express.js, as defined in `docs/architecture.md`.
-   **Authentication**: All routes must be protected. Use the `requireAuth` middleware from `server/middleware/authorizationMiddleware.ts`.
-   **Service Location**: The service to be used is the `BusinessIntelligenceService` class located in `server/services/businessIntelligenceService.ts`.
-   **API Endpoint Design**: Define RESTful endpoints based on the methods in `businessIntelligenceService.ts`. For example, `getUnifiedAnalytics` should map to `GET /api/bi/analytics`.
-   **Project Structure**: The new route file must be created at `server/routes/biRoutes.ts`.

### Testing
-   **Testing Strategy**: Unit tests are required for the routing layer.
-   **Test File Location**: `server/routes/biRoutes.test.ts`.
-   **Framework**: Use `vitest`.
-   **Guidance**: Mock the `businessIntelligenceService` dependency to isolate the routes for testing.

## Change Log

| Date       | Version | Description                 | Author       |
|------------|---------|-----------------------------|--------------|
| 2025-09-21 | 1.0     | Initial draft of API story. | Bob (Scrum Master) |
