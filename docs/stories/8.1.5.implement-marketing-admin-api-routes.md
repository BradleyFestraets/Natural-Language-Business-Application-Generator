
---
story_id: 8.1.5
epic_id: 8.1
title: "Implement Marketing Admin API Routes"
status: "Draft"
priority: "P1 (High - Unblocks Marketing UI)"
estimate: "5 story points"
dev_agent: "TBD"
---

# Story 8.1.5: Implement Marketing Admin API Routes

**As a** Marketing Manager,
**I want** a stable and documented set of internal API endpoints for the Marketing Automation service,
**so that** I can build, manage, and analyze campaigns from a dedicated admin dashboard.

## Story Overview

This story creates the internal API layer for the `marketingAutomationService.ts`. It involves creating a new, separate routing file for administrative actions to keep them distinct from the existing public-facing lead capture routes. These new endpoints will expose the core functionality of the service, including management of campaigns, audience segments, and lead capture forms.

## Acceptance Criteria

- [ ] A new `marketingAdminRoutes.ts` file is created in the `server/routes/` directory.
- [ ] Endpoints for managing Campaigns, Audience Segments, and Lead Capture forms are implemented, mapping to methods in `marketingAutomationService.ts`.
- [ ] All API routes are protected by the `requireAuth` middleware.
- [ ] The new router is integrated into the main Express app in `server/index.ts`.
- [ ] Unit tests are created for the new routes, mocking the service layer.

## Tasks / Subtasks

- [ ] **Task 1: Create and Integrate Marketing Admin Routes File** (AC: 1, 4)
    - [ ] Create the file `server/routes/marketingAdminRoutes.ts`.
    - [ ] Set up the Express router and import the `MarketingAutomationService` instance.
    - [ ] Add the new `marketingAdminRouter` to the main Express app in `server/index.ts` under a path like `/api/admin/marketing`.

- [ ] **Task 2: Implement Campaign Management Endpoints** (AC: 2, 3)
    - [ ] Implement `POST /campaigns` to call `createCampaign`.
    - [ ] Implement `POST /email-campaigns` to call `createEmailCampaign`.
    - [ ] *Add GET, LIST, and UPDATE endpoints for campaigns if corresponding service methods exist.*

- [ ] **Task 3: Implement Audience & Lead Capture Endpoints** (AC: 2, 3)
    - [ ] Implement `POST /audience-segments` to call `createAudienceSegment`.
    - [ ] Implement `POST /lead-captures` to call `createLeadCapture`.
    - [ ] *Add GET and LIST endpoints for these resources if corresponding service methods exist.*

- [ ] **Task 4: Implement Analytics Endpoint** (AC: 2, 3)
    - [ ] Implement `GET /analytics` to call `getMarketingAnalytics`.

- [ ] **Task 5: Create Unit Tests** (AC: 5)
    - [ ] Create `server/routes/marketingAdminRoutes.test.ts`.
    - [ ] Write basic tests for each new endpoint, mocking the `marketingAutomationService` dependency.

## Dev Notes

This story is essential for building the internal marketing management dashboard.

-   **Architecture Decision**: Create a **new file** `server/routes/marketingAdminRoutes.ts`. Do NOT add these admin routes to the existing `server/routes/marketingRoutes.ts`, which is for public lead capture. This separates internal and external APIs.
-   **Framework**: Use Express.js, as defined in `docs/architecture.md`.
-   **Authentication**: All routes must be protected. Use the `requireAuth` middleware from `server/middleware/authorizationMiddleware.ts`.
-   **Service Location**: The service to be used is the `MarketingAutomationService` class located in `server/services/marketingAutomationService.ts`.
-   **API Endpoint Design**: Define RESTful endpoints based on the methods in `marketingAutomationService.ts`. For example, `createCampaign` should map to `POST /api/admin/marketing/campaigns`.

### Testing
-   **Testing Strategy**: Unit tests are required for the routing layer.
-   **Test File Location**: `server/routes/marketingAdminRoutes.test.ts`.
-   **Framework**: Use `vitest`.
-   **Guidance**: Mock the `marketingAutomationService` dependency to isolate the routes for testing.

## Change Log

| Date       | Version | Description                 | Author       |
|------------|---------|-----------------------------|--------------|
| 2025-09-21 | 1.0     | Initial draft of API story. | Bob (Scrum Master) |
