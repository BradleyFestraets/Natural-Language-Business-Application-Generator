
---
story_id: 9.1.5
epic_id: 9.1
title: "Implement Customer Support API Routes"
status: "Draft"
priority: "P1 (High - Unblocks Support UI)"
estimate: "4 story points"
dev_agent: "TBD"
---

# Story 9.1.5: Implement Customer Support API Routes

**As a** Support Agent,
**I want** a stable and documented set of API endpoints for the Customer Support service,
**so that** I can manage tickets, search the knowledge base, and monitor customer health from a unified support dashboard.

## Story Overview

This story creates the essential API layer to make the `customerSupportService.ts` functional within the application. It involves creating a dedicated routing file for all support-related actions, including ticket management, knowledge base searching, and retrieving customer health and analytics data. This is the critical link needed to build any support-focused user interface.

## Acceptance Criteria

- [ ] A new `supportRoutes.ts` file is created in the `server/routes/` directory.
- [ ] Endpoints for managing Tickets, Knowledge Base, Customer Health, and Analytics are implemented, mapping to methods in `customerSupportService.ts`.
- [ ] All API routes are protected by the `requireAuth` middleware.
- [ ] The new router is integrated into the main Express app in `server/index.ts`.
- [ ] Unit tests are created for the new routes, mocking the service layer.

## Tasks / Subtasks

- [ ] **Task 1: Create and Integrate Support Routes File** (AC: 1, 4)
    - [ ] Create the file `server/routes/supportRoutes.ts`.
    - [ ] Set up the Express router and import the `CustomerSupportService` instance.
    - [ ] Add the new `supportRouter` to the main Express app in `server/index.ts` under the `/api/support` path.

- [ ] **Task 2: Implement Ticket Management Endpoints** (AC: 2, 3)
    - [ ] Implement `POST /tickets` to call `createTicket`.
    - [ ] Implement `POST /tickets/:id/interactions` to call `addTicketInteraction`.
    - [ ] Implement `PUT /tickets/:id/status` to call `updateTicketStatus`.
    - [ ] *Add GET and LIST endpoints for tickets if corresponding service methods exist.*

- [ ] **Task 3: Implement Knowledge Base & Health Endpoints** (AC: 2, 3)
    - [ ] Implement `GET /kb/search` to call `searchKnowledgeBase`.
    - [ ] Implement `GET /customers/:id/health` to call `calculateCustomerHealth`.

- [ ] **Task 4: Implement Analytics Endpoint** (AC: 2, 3)
    - [ ] Implement `GET /analytics` to call `getSupportAnalytics`.

- [ ] **Task 5: Create Unit Tests** (AC: 5)
    - [ ] Create `server/routes/supportRoutes.test.ts`.
    - [ ] Write basic tests for each new endpoint, mocking the `customerSupportService` dependency.

## Dev Notes

This story enables the creation of the customer support dashboard and agent tools.

-   **Framework**: Use Express.js, as defined in `docs/architecture.md`.
-   **Authentication**: All routes must be protected. Use the `requireAuth` middleware from `server/middleware/authorizationMiddleware.ts`.
-   **Service Location**: The service to be used is the `CustomerSupportService` class located in `server/services/customerSupportService.ts`.
-   **API Endpoint Design**: Define RESTful endpoints based on the methods in `customerSupportService.ts`. For example, `createTicket` should map to `POST /api/support/tickets`.
-   **Project Structure**: The new route file must be created at `server/routes/supportRoutes.ts`.

### Testing
-   **Testing Strategy**: Unit tests are required for the routing layer.
-   **Test File Location**: `server/routes/supportRoutes.test.ts`.
-   **Framework**: Use `vitest`.
-   **Guidance**: Mock the `customerSupportService` dependency to isolate the routes for testing.

## Change Log

| Date       | Version | Description                 | Author       |
|------------|---------|-----------------------------|--------------|
| 2025-09-21 | 1.0     | Initial draft of API story. | Bob (Scrum Master) |
